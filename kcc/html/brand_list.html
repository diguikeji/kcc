<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title>品牌</title>
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/page.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		<link rel="stylesheet" href="../css/swiper.min.css">
		<link rel="stylesheet" href="../css/app.css">
		<style type="text/css">
			
			body{
				background: #f1f1f1;
			}
			.head_right{
				float: right;
			}
			
			.select_type{
				height: 0.45rem;
				align-items: center;
				justify-content: space-around;
				background: #F1F1F1;
				color: #666666;
				font-size: 0.16rem;
				position: fixed;
				width: 100%;
				box-sizing: border-box;
				border-bottom: 1px solid #E9E9E9;
				top:0.44rem;
				z-index:1000;
			}
			.select_type .item .active_line{display: none;}

			.select_type .item.active{
				color: #000;
				font-weight: bold;
			}

			.select_type .item.active .active_line{display: block;}
			
			
			.active_line{
				height: 0.02rem;
				width: 0.5rem;
				background-color: #3E4EAA;
				border-radius: 4px;
				position: absolute;
				bottom: 0px;
				left: 50%;
				margin-left: -0.25rem;
			}
			
			.select_type .item{
				height: 0.45rem;
				position: relative;
				font-size:0.13rem;
			}
			
			.content_wrap{
				padding:1.05rem 0.15rem 0.15rem 0.15rem;

			}

			.swiper-detail{
				width:100%;
				height:100%;
				overflow: auto;
			}
			
			.content_head{
				border-radius: 0.05rem;
				height: 1.1rem;
				padding: 0.12rem 0.3rem;
				box-sizing: border-box;
				background-color: #fff;
			}
			
			.circle {
                width: 1rem;
                height: 1rem;
                position: relative;
                border-radius: 50%;
            }
                 
            .clip_left,.clip_right{
                width:1rem;
                height:1rem;
                position: absolute;
                top: 0px;left: 0px;
            }
            .circle_left, .circle_right{
                width:1rem;
                height:1rem;
                position: absolute;
                border-radius: 50%;
                top: 0px;left: 0px;
                background-color: #DCDCDC;
            }
            /*出于展示用的改变背景色*/
            /*.circle_left{
                background: green;
            }
            .circle_right{
                background: lightblue;
            }*/
            .circle_right,.clip_right {
                clip:rect(0,auto,auto,0.5rem);
            }
            .circle_left , .clip_left{
                clip:rect(0,0.5rem,auto,0);
            }
                 
            /*
            *当top和left取值为auto时，相当于0
            *当bottom和right取值为auto时，相当于100%
            */

			.huan{margin-top:0.1rem;}

            .mask {
                width: 0.75rem;
                height: 0.75rem;
                border-radius: 50%;
                left: 0.12rem;
                top: 0.12rem;
                position: absolute;
                font-size: 16px;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				line-height: normal;
            }
			
			.percent_num{
				color: #9DA1E7;
				font-size: 0.16rem;
			}
			
			.percent{
				color: #9DA1E7;
				font-size: 0.13rem;
			}
			
			.contain {
				width: 0.1rem;
				margin-right:0.02rem;
				position: relative;top:-0.02rem;
			}
			
			.corner {
				width: 0px;                 /*  宽高设置为0，很重要，否则达不到效果 */
				height: 0px;
				border: 0.05rem solid #333;
				border-top-color: transparent;    /* 设置透明背景色 */
				border-left-color: transparent;
				border-right-color: transparent;
			}
			
			.recommand_text{
				color: #9B9B9B;
				font-size:0.11rem;
			}
			
			
			.head_wrap{
				height: 100%;
				padding: 0.1rem 0rem;
				align-items:baseline;
			}
			
			.head_name{
				font-size: 0.16rem;
				font-weight: bold;
				color: #000;
			}
			
			.head_left_wrap .item{
				width: 1.1rem;
				font-size:0.12rem;
			}
			
			.head_left_wrap .item span:nth-child(1){
				color: #9B9B9B;
			}
			
			.wrap{
				height: 1.5rem;
				background-color: #fff;
				padding: 0rem 0rem 0rem 0.2rem;
				box-sizing: border-box;
			}
			.wrap .item_wrap{
				height: 1.5rem;
				border-bottom: 1px solid #E7E7E7;
				display: flex;
				flex-direction: row;
				padding: 0.2rem 0rem;
			}
			
			.left_wrap{
				width: 90%;
				height: 100%;
				display: flex;
				flex-direction: column;
				justify-content: space-between;
			}

			.left_wrap .second-text{font-size:0.11rem;color:#333;}

			.left_wrap .third-text{font-size:0.11rem;color:#999;}
			
			.right_wrap{
				width: 10%;
				height: 100%;
				
			}
			
			.right_wrap img{
				height: 0.3rem;
			}
			
			.head_title{
				display: flex;
				flex-direction: row;
			}
			
			.container {
			  width: 100%;
			  background-color: #9DA1E7;
			  border-radius: 0.2rem;
			  position: relative;
			  height: 0.2rem;
			  font-size:0.09rem;
			  margin-top:-0.05rem;
			}
			
			.container .right{
				position: absolute;
				right: 0.1rem;
				top: 0;
				color: #fff;
			}

			.skills {
			  text-align: right;
			  padding-left: 0.1rem;
			  color: white;
			  border-top-left-radius: 0.2rem;
			  border-bottom-left-radius: 0.2rem;
			  height: 0.2rem;
			}
			
			.left {width: 60%; background-color: #5A64B0;text-align: left;}
			
			.add_num{
				color: #FC595C;
				font-size:0.12rem;
			}
			.reduce_num{
				color: #5ABE68;
				font-size:0.12rem;
			}
			
		</style>
	</head>
	<body>


	<div class="header-bar">

		<div class="header-left" onclick="mui.back();">
			<span class="mui-icon mui-icon-arrowleft"></span>
		</div>

		<div class="header-title">品类选择</div>


		<div class="header-right" ontouchstart="showCondition();" >
			<img s src="../images/icon/tab_menu_filter@2x.png"/>
		</div>


	</div>
		
		
		<div class="mui-content" style="text-align: center; background: #F1F1F1;">

			<div class="row select_type">


			</div>


			<div class="swiper-container swiper-banner">
				<div class="swiper-wrapper" id="allList">




				</div>
			</div>



			
			
		</div>
		
		

	</body>
	<script type="text/javascript" src="../js/mui.min.js"></script>
	<script src="../js/jquery-2.1.1.min.js"></script>
	<script src="../js/app.js"></script>
	<script src="../js/myStorage.js"></script>
	<script src="../js/moment.min.js"></script>
	<script src="../js/condition.js"></script>
	<script src="../js/mui.picker.min.js"></script>
	<script src="../js/circleChart.min.js"></script>
	<script src="../lib/swiper.min.js"></script>
	<script type="text/javascript">
		
		mui.init();
		
		mui.plusReady(function() {

			httpRequest()

		});

		mui("body").on('tap','.wrap',function(event){

			var product_line_id=$(this).attr("data-id");

			Global.openWindow({
				url: 'jingpin.html?product_line_id='+product_line_id,
				id: 'jingpin.html',
				waiting: {
					autoShow: false
				}
			})


		});


		mui("body").on('tap','.select_type .item',function(event){

			$(".select_type .item").removeClass("active");
			$(this).addClass("active");

			swiper.slideTo($(this).index(), 500, false);


		});

		function  firstInitData()
		{
			
			$("#allList .swiper-slide").each(function(index)
			{
				xunhuan($(this));
			});
		}

		var waitingLoading;
		function xunhuan($obj)
		{
			if(!waitingLoading)
			{
				waitingLoading = plus.nativeUI.showWaiting("加载中...");
			}

			$obj.find(".brand-list").empty();

			$("#rightModal").hide();

			var param={};
			param.category_id=$obj.attr("data-id");

			var platform_id="";
			$(".platforms-list .active").each(function(index)
			{
				platform_id=platform_id+","+$(this).attr("data-id");
			});

			platform_id=platform_id.slice(1);

			param.platform_id=platform_id
			param.start_date=$("#startTime").text();
			param.end_date=$("#endTime").text();
			param.brand_id=brand_id;

			console.log("获取品类好评率条件");
			console.log(JSON.stringify(param));

			Global.commonAjax({
				url: 'app/brand/get-category-praise-ratio/',
				data:param,
				method: 'GET'
			}, function(data){

				console.log("获取品类好评率返回数据");
				console.log(JSON.stringify(data));

				data=data.category_praise_ratio;
				var praise_ratio=parseFloat(data.praise_ratio*100).toFixed(2);
				//$(".percent_num").text(praise_ratio);

				$obj.find(".huan").circleChart({
					size: 80,
					value: praise_ratio,
					text: "",
					color:"#9D9FE9",
					onDraw: function(el, circle) {

						var timeId=setInterval(function() {
							var percent_num=parseInt($obj.find(".percent_num").text());
							if(percent_num>=praise_ratio)
							{
								clearInterval(timeId);
							}
							else {
								percent_num++
								$obj.find(".percent_num").text(percent_num);
							}

						}, 500);

					}
				});

				$obj.find(".competition_praise_ratio").text(parseFloat(data.competition_praise_ratio*100).toFixed(2));
				$obj.find(".ring_praise_ratio").text(parseFloat(data.ring_praise_ratio*100).toFixed(2));


			},function(err)
			{
				console.log("品牌条件返回数据失败"+err);
			});



			Global.commonAjax({
				url: 'app/brand/get-product-line-praise-ratio/',
				data:param,
				method: 'GET'
			}, function(data){

				console.log("获取产品线好评率返回数据");
				console.log(JSON.stringify(data));


				if($obj.index()==$(".select_type .item").length-1)
				{
					waitingLoading.close();
				}

				data=data.product_line_praise_ratio;

				for(var i=0;i<data.length;i++)
				{
					var ring_praise_ratio=(data[i].ring_praise_ratio*100).toFixed(2);
					var ring_bad_ratio=(data[i].ring_bad_ratio*100).toFixed(2);

					var praise_ratio=(data[i].praise_ratio*100).toFixed(2);
					var bad_ratio=(data[i].bad_ratio*100).toFixed(2);

					var ring_praise_ratioHtml="";
					if(ring_praise_ratio>0)
					{
						ring_praise_ratioHtml='<span class="add_num ">+'+ring_praise_ratio+'%</span>';
					}
					else {
						ring_praise_ratioHtml='<span class="reduce_num">'+ring_praise_ratio+'%</span>';
					}

					var ring_bad_ratioHtml="";
					if(ring_bad_ratio>0)
					{
						ring_bad_ratioHtml='<span class="add_num">+'+ring_bad_ratio+'%</span>';
					}
					else {
						ring_bad_ratioHtml='<span class="reduce_num">'+ring_bad_ratio+'%</span>';
					}

					$obj.find(".brand-list").append('<div class="wrap" data-id="'+data[i].product_line_id+'"><div class="item_wrap">' +
							'<div class="left_wrap"><div class="head_title">' +
							'<span class="head_name">'+data[i].product_line_name+'</span></div> ' +
							'<div class="row_between second-text"><span>好评'+data[i].praise_total+'</span><span>差评'+data[i].bad_total+'</span>' +
							'</div><div class="container">' +
							'<div class="skills left">'+praise_ratio+'%</div><span class="right">'+bad_ratio+'%</span></div>' +
							'<div class="row_between third-text"><div>' +
							'<span>环比增长</span>' +ring_praise_ratioHtml+
							'</div><div><span>环比增长</span>'+ring_bad_ratioHtml+
							'</div></div></div>' +
							'<div class="row_center right_wrap">' +
							'<img src="../images/load_more.png">' +
							'</div></div></div>');
				}



			},function(err)
			{
				console.log("品牌条件返回数据失败"+err);
			});


		}

		function slideChange()
		{
			var index=swiper.activeIndex;

			$(".select_type .item").removeClass("active");
			$(".select_type .item").eq(index).addClass("active");


		}


		var brand_id=GetQueryString("brand_id");

		var swiper;

		function httpRequest()
		{
			Global.commonAjax({
				url: 'app/brand/get-categorys/',
				data: {brand_id:brand_id}
			}, function(data){

				console.log("收藏品牌列表");
				for(var i=0;i<data.categorys.length;i++)
				{

					$(".select_type").append('<div  data-id="'+data.categorys[i].category_id+'" class="col_center item">'+
							'<span class="titleType" >'+data.categorys[i].category_name+'</span>'+
							'<span class="active_line"></span>'+
							'</div>');

					$("#allList").append('' +
					'<div class="swiper-slide" data-id="'+data.categorys[i].category_id+'">'+
						'<div class="swiper-detail" >' +

							'<div class="content_wrap">'+

							'<div class="row_between content_head">'+
								'<div class="col_between head_wrap">'+
									'<div class="head_name head_name_top">'+data.categorys[i].category_name+'</div>'+
									'<div class="head_left_wrap">'+
										'<div class="row_between item">'+
											'<span>高出行业</span><span><span  class="competition_praise_ratio">0</span>%</span>'+
										'</div>'+

										'<div class="row_between item">'+
											'<span>当月环比</span>'+
											'<div class="row_center">'+
													'<div class="contain">'+
													'<div class="corner"></div>'+
													'</div>'+
													'<div><span class="ring_praise_ratio">0</span>%</div>'+
											'</div>'+
										'</div>'+

										'</div>'+
									'</div>'+

								'<div class="circle">'+
									'<div class="huan"></div>'+
									'<div class="mask">'+
										'<div><span class="percent_num">0</span><span class="percent">%</span></div>'+
										'<span class="recommand_text">好评率</span>'+
									'</div>'+
								'</div>'+

							'</div>' +

							'</div>'+
							'<div class="brand-list"></div>' +

						'</div>'+
					'</div>');

				}

				$(".swiper-detail").height($(window).height());

				$(".select_type div").eq(0).addClass("active");


				swiper = new Swiper('.swiper-banner', {
					on:{
						slideChange: function()
						{
							slideChange();
						}
					}

				});

				getCondition();


			}, function(err){
				console.log("收藏品牌列表失败"+err);
			});
		}



		

		

		
	</script>
</html>
